# 실시간 메시징이 중요해?
현재 나는 선생님과 학생이 같은 화면을 보며 실시간으로 소통할 수 있는 웹 기반 전자칠판 서비스를 개발·운영하고 있다.

전자칠판 서비스에서 실시간 메시징은 선택이 아니라 필수다.

선생님이 전자칠판에 글을 작성하거나 도형을 추가하고요소를 이동·삭제하는 순간 그 변화가 학생들의 화면에도 즉시 반영되어야 실제 수업과 같은 의사소통이 가능해지기 때문이다.

즉, 한 사용자의 행동이 지연 없이 다른 사용자에게 전달되고 모든 사용자가 같은 상태의 화면을 공유해야 한다.

이 요구사항을 만족하지 못한다면 전자칠판은 단순히 내용을 공유하는 일반적인 게시판에 불과해진다.

그래서 전자칠판 서비스에서는 **안정적이고 확장 가능한 실시간 메시징 구조**가 필요했고 이를 위해 **WebSocket + Kafka** 기반의 실시간 메시징 아키텍처를 구성하게 되었다.

이 글에서는 실제 서비스에서 메시지가 어떤 흐름으로 전달되는지를 중심으로 전자칠판 서비스 내 실시간 메시징 처리가 어떻게 이루어지고 있는지 정리해보려 한다.

***

# 실시간 메시징 아키텍처 개요

전자칠판 서비스의 실시간 메시징은
WebSocket + Kafka를 중심으로 구성된 구조를 사용하고 있다.

![
kafka
](./img/kafka/kafka.jpeg)

전체 흐름을 단순화하면 다음과 같다.

1. 클라이언트(선생님/학생)는 WebSocket을 통해 서버와 연결된다.
2. 사용자의 행동(게시물 작성, 이동, 삭제 등)은 WebSocket을 통해 서버로 전달된다.
3. 서버는 해당 이벤트를 Kafka로 전달한다.
4. Kafka는 메시지를 모든 서버 인스턴스에 전달한다.
5. 각 서버는 자신에게 연결된 클라이언트에게 WebSocket으로 메시지를 다시 전파한다.

이 구조를 통해 특정 서버 인스턴스에 종속되지 않고
여러 서버로 확장된 환경에서도 모든 사용자가 동일한 실시간 화면을 공유할 수 있다.

## 웹소켓은 무엇인가?
> 웹소켓이 왜 필요한건대?

![
websocket
](./img/kafka/websocket.jpeg)

웹 소켓은 HTML5에 등장 실시간 웹 애플리케이션을 위해 설계된 통신 프로토콜이며, TCP(Transmission Control Protocol)를 기반으로 합니다.  

TCP를 기반으로 한 웹 소켓은 신뢰성 있는 데이터 전송을 보장하며, 메시지 경계를 존중하고, 순서가 보장된 양방향 통신을 제공할 수 있습니다.  

HTTP와 다르게 클라이언트와 서버 간에 최초 연결이 이루어지면, 이 연결을 통해 양방향 통신을 지속적으로 할 수 있습니다.   

즉, 전화 통화와 같이 양쪽 모두에서 정보를 주고받을 수 있다는 의미입니다.   

이 '지속적 연결'을 통해서 서버는 클라이언트에게 실시간으로 데이터를 보낼 수 있으며, 반대로 클라이언트도 서버에게 데이터를 보낼 수 있습니다. 

이때 데이터는 ‘패킷(packet)’ 형태로 전달되며, 전송은 연결 중단과 추가 HTTP 요청 없이 양방향으로 이뤄집니다.   

또한 웹소켓 연결을 하려면 new WebSocket을 호출하면 되는데, 이때 ws라는 특수 프로토콜을 사용합니다.

```java
const socket = new WebSocket("ws://yong-nyong.tistory.com/socket");
```

### HTTP vs WebSocket 차이

| 구분 | HTTP | WebSocket |
|----|----|----|
| 연결 방식 | 요청-응답 | 연결 유지 |
| 연결 수명 | 요청마다 새로 | 한 번 연결 후 지속 |
| 통신 방향 | 단방향(요청 기반) | 양방향 |
| 서버 → 클라이언트 | 불가능 | 가능 |
| 실시간성 | 낮음 | 매우 높음 |

HTTP는 클라이언트의 요청이 있어야만 서버가 응답할 수 있는 구조인 반면,  
WebSocket은 연결을 유지한 채 서버와 클라이언트가 서로 자유롭게 메시지를 주고받을 수 있다.

>WebSocket은 하나의 TCP 연결을 유지한 채
클라이언트와 서버가 언제든지 메시지를 주고받을 수 있는
양방향 통신 프로토콜이다.

>기존 HTTP 통신은 클라이언트 요청이 있어야만
서버가 응답할 수 있는 구조이기 때문에
실시간 메시징 처리에는 한계가 있다.

>전자칠판 서비스에서는
선생님의 행동이 즉시 학생 화면에 반영되어야 하므로,
서버가 클라이언트에게 즉시 메시지를 전달할 수 있는
WebSocket이 실시간 메시징의 핵심 역할을 한다.
